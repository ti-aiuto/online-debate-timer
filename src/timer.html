<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>„Çø„Ç§„Éû„Éº</title>
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,user-scalable=no"
    />
    <link rel="preconnect" href="https://fonts.gstatic.com" />
    <link
      href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@500&display=swap"
      rel="stylesheet"
    />
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
    <style type="text/css">
      * {
        margin: 0;
        padding: 0;
      }

      body {
        font-family: sans-serif;
      }

      .container {
        max-width: 380px;
        margin: auto;
      }

      .timer {
        box-shadow: 0 0 3px #bbb;
        border-radius: 24px;
        margin: 12px;
        padding: 8px 0;
      }

      .timer__time-display {
        margin: 20px;
        margin-bottom: 16px;
        background-color: #bbc8ba;
        position: relative;
      }

      .timer__sound-badge {
        position: absolute;
        right: 0;
        top: 0;
        font-size: 0.7rem;
        padding: 5px;
      }

      .timer__time-display-digits {
        padding: 8px 0;
        font-size: 7rem;
        line-height: 7rem;
        text-align: center;
        font-family: 'Inconsolata', monospace;
      }

      .timer__controls {
        margin-bottom: 16px;
      }

      .timer__controls-row {
        display: flex;
        margin: 0 12px;
      }

      .timer__control-button {
        font-size: 1.1rem;
        margin: 6px;
        padding: 12px 8px;
        border-radius: 20px;
        font-family: monospace;
        touch-action: manipulation;
        border: none;
        border-top: solid 1px #eee;
        background-color: #fff;
        box-shadow: 0 1px 2px #777;
        color: #555;
        flex: 1;
      }

      .timer__control-button:active {
        box-shadow: 0 0px 2px #777 inset;
      }

      .timer__control-button:disabled {
        color: #ccc;
      }

      .timer__control-button:disabled:active {
        box-shadow: 0 1px 2px #777;
      }

      .timer__how-to-use {
        font-size: 0.6rem;
        color: #555;
        margin: 0 20px 4px 20px;
      }

      .timer__copyright {
        margin: 0 20px 12px 20px;
      }

      .timer__copyright,
      .timer__copyright a {
        font-size: 0.6rem;
        color: #999;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="timer">
        <div id="timer-ui">
          <div class="timer__time-display">
            <time-display
              :sec="currentSec"
              class="timer__time-display-digits"
            ></time-display>

            <div class="timer__sound-badge">{{soundEnabled ? "üì¢" : "üîá"}}</div>
          </div>
          <div class="timer__controls">
            <div class="timer__controls-row">
              <button
                v-if="!isCountingDown && !isCountingDownCompleted"
                @click="startButton"
                class="timer__control-button"
                :disabled="!canGoToCountingDown"
              >
                „Çπ„Çø„Éº„Éà
              </button>
              <button
                v-if="isCountingDown"
                @click="pauseButton"
                class="timer__control-button"
                :disabled="!canGoToPausingCountDown"
              >
                ‰∏ÄÊôÇÂÅúÊ≠¢
              </button>
              <button
                v-if="isCountingDownCompleted"
                @click="restoreButton"
                class="timer__control-button"
                :disabled="!isCountingDownCompleted"
              >
                È≥¥ÂãïÂÅúÊ≠¢
              </button>

              <button @click="resetButton" class="timer__control-button">
                „É™„Çª„ÉÉ„Éà
              </button>
            </div>
            <div class="timer__controls-row">
              <button
                @click="addMinutesButton(1)"
                class="timer__control-button"
                :disabled="!canGoToSettingTime"
              >
                +ÂàÜ
              </button>
              <button
                @click="addSecondsButton(10)"
                class="timer__control-button"
                :disabled="!canGoToSettingTime"
              >
                +10Áßí
              </button>
              <button
                @click="addSecondsButton(1)"
                class="timer__control-button"
                :disabled="!canGoToSettingTime"
              >
                +Áßí
              </button>
            </div>
            <div class="timer__controls-row">
              <button
                @click="setSecButton(60)"
                class="timer__control-button"
                :disabled="!canGoToSettingTime"
              >
                1ÂàÜ
              </button>
              <button
                @click="setSecButton(120)"
                class="timer__control-button"
                :disabled="!canGoToSettingTime"
              >
                2ÂàÜ
              </button>
              <button
                @click="setSecButton(180)"
                class="timer__control-button"
                :disabled="!canGoToSettingTime"
              >
                3ÂàÜ
              </button>
              <button
                @click="setSecButton(240)"
                class="timer__control-button"
                :disabled="!canGoToSettingTime"
              >
                4ÂàÜ
              </button>
              <button
                @click="setSecButton(360)"
                class="timer__control-button"
                :disabled="!canGoToSettingTime"
              >
                6ÂàÜ
              </button>
            </div>
            <div class="timer__controls-row">
              <button
                @click="testPlaySoundButton"
                class="timer__control-button"
                :disabled="isCountingDown"
              >
                „ÉÜ„Çπ„ÉàÂÜçÁîü
              </button>

              <button
                v-if="soundEnabled"
                @click="disableSoundButton"
                class="timer__control-button"
              >
                Èü≥„ÇíOFF
              </button>

              <button
                v-if="!soundEnabled"
                @click="enableSoundButton"
                class="timer__control-button"
              >
                Èü≥„ÇíON
              </button>
            </div>
          </div>
        </div>

        <div class="timer__how-to-use">
          ‚ÄªiOS„ÅßÂäπÊûúÈü≥„ÇíÈ≥¥„Çâ„Åó„Åü„ÅÑÂ†¥Âêà„ÅØ‰∏ÄÂ∫¶„Äå„ÉÜ„Çπ„ÉàÂÜçÁîü„Äç„ÇíÊäº„Åó„Å¶„Åè„Å†„Åï„ÅÑ
        </div>
        <div class="timer__copyright">
          <a href="https://github.com/ti-aiuto/online-debate-timer"
            >https://github.com/ti-aiuto/online-debate-timer</a
          >
        </div>
      </div>
    </div>

    <script type="text/javascript">
      // „Çø„Ç§„Éû„Éº„ÅÆÁä∂ÊÖãÈÅ∑Áßª„ÇíÊï¥ÁêÜ„Åó„Åü„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
      const TkTimerStateValue = Object.freeze({
        INITIAL_STATE: 'INITIAL_STATE',
        SETTING_TIME: 'SETTING_TIME',
        COUNTING_DOWN: 'COUNTING_DOWN',
        PAUSING_COUNTING_DOWN: 'PAUSING_COUNTING_DOWN',
        COUNTING_DOWN_COMPLETED: 'COUNTING_DOWN_COMPLETED',
      })
      const TkTimerState = function () {
        this.state = TkTimerStateValue.INITIAL_STATE
      }
      TkTimerState.prototype.setStateChangedCallback = function (callback) {
        this.stateChangedCallback = callback
      }
      TkTimerState.prototype.notifyStateChanged = function () {
        if (this.stateChangedCallback) {
          this.stateChangedCallback(this.state)
        }
      }
      TkTimerState.prototype.canGoToInitialState = function () {
        return true // „Å©„Åì„Åã„Çâ„ÇÇË®±ÂèØ
      }
      TkTimerState.prototype.goToInitialState = function () {
        if (!this.canGoToInitialState()) {
          return
        }
        this.state = TkTimerStateValue.INITIAL_STATE
        this.notifyStateChanged()
      }
      TkTimerState.prototype.isInitialState = function () {
        return this.state === TkTimerStateValue.INITIAL_STATE
      }
      TkTimerState.prototype.canGoToSettingTime = function () {
        return (
          this.isInitialState() ||
          this.isSettingTime() ||
          this.isCountingDownCompleted()
        )
      }
      TkTimerState.prototype.goToSettingTime = function () {
        if (!this.canGoToSettingTime()) {
          return
        }
        this.state = TkTimerStateValue.SETTING_TIME
        this.notifyStateChanged()
      }
      TkTimerState.prototype.isSettingTime = function () {
        return this.state === TkTimerStateValue.SETTING_TIME
      }
      TkTimerState.prototype.canGoToCountingDown = function () {
        return this.isSettingTime() || this.isPausingCountDown()
      }
      TkTimerState.prototype.goToCountingDown = function () {
        if (!this.canGoToCountingDown()) {
          return
        }
        this.state = TkTimerStateValue.COUNTING_DOWN
        this.notifyStateChanged()
      }
      TkTimerState.prototype.isCountingDown = function () {
        return this.state === TkTimerStateValue.COUNTING_DOWN
      }
      TkTimerState.prototype.canGoToPausingCountDown = function () {
        return this.isCountingDown()
      }
      TkTimerState.prototype.goToPausingCountDown = function () {
        if (!this.canGoToPausingCountDown()) {
          return
        }
        this.state = TkTimerStateValue.PAUSING_COUNTING_DOWN
        this.notifyStateChanged()
      }
      TkTimerState.prototype.isPausingCountDown = function () {
        return this.state === TkTimerStateValue.PAUSING_COUNTING_DOWN
      }
      TkTimerState.prototype.canGoToCountingDownCompleted = function () {
        return this.isCountingDown()
      }
      TkTimerState.prototype.goToCountingDownCompleted = function () {
        if (!this.canGoToCountingDownCompleted()) {
          return
        }
        this.state = TkTimerStateValue.COUNTING_DOWN_COMPLETED
        this.notifyStateChanged()
      }
      TkTimerState.prototype.isCountingDownCompleted = function () {
        return this.state === TkTimerStateValue.COUNTING_DOWN_COMPLETED
      }

      const TIMER_UPPER_LIMIT = 60 * 99 + 60 - 1

      // „Çø„Ç§„Éû„Éº„É≠„Ç∏„ÉÉ„ÇØ
      const TkTimer = function () {
        this.state = new TkTimerState()
        this.init()
      }
      TkTimer.prototype.setTickCallback = function (callback) {
        this.tickCallback = callback
      }
      TkTimer.prototype.clearTimer = function () {
        clearInterval(this.timerId)
        this.timerId = null
        this.tickStartedAtMsec = null
        this.lastTimeTickedSec = 0
      }
      TkTimer.prototype.init = function () {
        this.clearTimer()
        this.rememberedTargetSec = 0
        this.currentSec = 0
      }
      TkTimer.prototype.notifyCurrentSec = function () {
        if (this.tickCallback) {
          this.tickCallback(this.currentSec)
        }
      }
      TkTimer.prototype.setSec = function (secArg) {
        if (!this.state.canGoToSettingTime()) {
          return
        }
        if (!(secArg + '').match(/^\d+$/)) {
          return
        }
        sec = Number(secArg)
        if (sec < 0) {
          return
        }
        if (sec > TIMER_UPPER_LIMIT) {
          sec = TIMER_UPPER_LIMIT
        }
        this.currentSec = sec
        this.notifyCurrentSec()
        this.state.goToSettingTime()
      }
      TkTimer.prototype.addSeconds = function (sec) {
        if (!this.state.canGoToSettingTime()) {
          return
        }
        this.setSec(this.currentSec + sec)
      }
      TkTimer.prototype.onSecTick = function () {
        if (this.state.isCountingDown()) {
          this.currentSec -= 1
          this.notifyCurrentSec()
          if (this.currentSec <= 0) {
            this.clearTimer()
            this.state.goToCountingDownCompleted()
          }
        } else {
          // „ÅÑ„Å§„Åãup„ÇÇÂÆüË£Ö
        }
      }
      TkTimer.prototype.onIntervalTick = function () {
        // „Çπ„Çø„Éº„ÉàÊôÇÁÇπ„ÅÆÊôÇÂàª„Å®ÁèæÂú®ÊôÇÂàª„ÇíÊØîËºÉ„Åó„Å¶Ê≠£Á¢∫„Å™ÁµåÈÅéÊôÇÈñì„ÇíË®àÊ∏¨„Åô„Çã
        const currentTime = Date.now()
        const d = currentTime - this.tickStartedAtMsec
        const timeTickedSec = Math.floor(d / 1000)
        if (timeTickedSec !== this.lastTimeTickedSec) {
          this.onSecTick()
          this.lastTimeTickedSec = timeTickedSec
        }
      }
      TkTimer.prototype.start = function () {
        if (this.state.canGoToCountingDown()) {
          if (this.currentSec === 0) {
            return
          }
          if (this.state.isSettingTime()) {
            // Êñ∞Ë¶è„Å´„Ç´„Ç¶„É≥„Éà„ÉÄ„Ç¶„É≥„Çí„Çπ„Çø„Éº„Éà„Åô„ÇãÂ†¥Âêà„Å†„ÅëË®≠ÂÆöÊôÇÈñì„ÇíË¶ö„Åà„Å¶„Åä„Åè
            this.rememberedTargetSec = this.currentSec
          }
          this.state.goToCountingDown()
          this.tickStartedAtMsec = Date.now()
          const that = this
          this.timerId = setInterval(function () {
            that.onIntervalTick()
          }, 50)
        } else {
          // „ÅÑ„Å§„Åãup„ÇÇÂÆüË£Ö
        }
      }
      TkTimer.prototype.pause = function () {
        if (!this.state.canGoToPausingCountDown()) {
          return
        }
        this.clearTimer()
        this.state.goToPausingCountDown()
      }
      TkTimer.prototype.restore = function () {
        if (this.state.canGoToSettingTime()) {
          this.setSec(this.rememberedTargetSec)
          // ÈÅ∑Áßª„ÅØ‰∏≠„Åß„ÇÑ„Å£„Å¶„Åè„Çå„Çã
        }
      }
      TkTimer.prototype.reset = function () {
        if (this.state.canGoToInitialState()) {
          this.init()
          this.notifyCurrentSec()
          this.state.goToInitialState()
        }
      }

      const zeroPadding = function (number) {
        return ('000' + number).slice(-2)
      }

      const toHankakuNumber = function (str) {
        return str.replace(/[Ôºê-Ôºô]/g, function (s) {
          return String.fromCharCode(s.charCodeAt(0) - 0xfee0)
        })
      }

      // „Çø„Ç§„Éû„Éº„ÅÆÊï∞ÂÄ§Ë°®Á§∫ÈÉ®ÂàÜ„ÅÆ„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
      Vue.component('time-display', {
        template: '<div class="timer-time">{{minutes}}:{{seconds}}</div>',
        props: {
          sec: {
            type: Number,
            required: true,
          },
        },
        computed: {
          minutes: function () {
            return zeroPadding(Math.floor(this.sec / 60))
          },
          seconds: function () {
            return zeroPadding(this.sec % 60)
          },
        },
      })

      // „Çø„Ç§„Éû„ÉºUI
      const app = new Vue({
        el: '#timer-ui',
        data: function () {
          const timer = new TkTimer()
          timer.setTickCallback(this.onTick)
          timer.state.setStateChangedCallback(this.onStateChanged)
          const timeUpAudio = new Audio('timer-timeup.mp3')
          timeUpAudio.load()
          return {
            currentSec: 0,
            timer: timer,
            timeUpAudio: timeUpAudio,
            soundEnabled: true,
          }
        },
        methods: {
          onTick: function (sec) {
            this.currentSec = sec
          },
          onStateChanged: function () {
            this.stopTimeUpAudio()
            if (this.timer.state.isCountingDownCompleted()) {
              this.startTimeUpAudio()
            }
          },
          startTimeUpAudio: function () {
            if (!this.soundEnabled) {
              return
            }
            try {
              this.timeUpAudio.currentTime = 0
              this.timeUpAudio.loop = true
              this.timeUpAudio.play()
            } catch (e) {}
          },
          stopTimeUpAudio: function () {
            try {
              this.timeUpAudio.pause()
            } catch (e) {}
          },
          startButton: function () {
            this.timer.start()
          },
          pauseButton: function () {
            this.timer.pause()
          },
          restoreButton: function () {
            this.timer.restore()
          },
          resetButton: function () {
            this.timer.reset()
          },
          addMinutesButton: function (min) {
            this.timer.addSeconds(min * 60)
          },
          addSecondsButton: function (sec) {
            this.timer.addSeconds(sec)
          },
          setSecButton: function (sec) {
            this.timer.setSec(sec)
          },
          testPlaySoundButton: function () {
            try {
              this.timeUpAudio.currentTime = 7.3
              this.timeUpAudio.loop = false
              this.timeUpAudio.play()
            } catch (e) {}
          },
          enableSoundButton: function () {
            this.soundEnabled = true
          },
          disableSoundButton: function () {
            this.soundEnabled = false
          },
        },
        computed: {
          canGoToCountingDown: function () {
            return this.timer.state.canGoToCountingDown()
          },
          canGoToPausingCountDown: function () {
            return this.timer.state.canGoToPausingCountDown()
          },
          isCountingDown: function () {
            return this.timer.state.isCountingDown()
          },
          isCountingDownCompleted: function () {
            return this.timer.state.isCountingDownCompleted()
          },
          canGoToSettingTime: function () {
            return this.timer.state.canGoToSettingTime()
          },
        },
      })
    </script>
  </body>
</html>
