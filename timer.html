<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8" />
    <title>タイマー</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue@2"></script> -->
  </head>
  <body>
    <div id="timer-ui">
      <div>{{currentSec}}</div>
      <div>
        <div>00:00</div>
        <button @click="startButton">スタート</button>
        <button @click="stopButton">ストップ</button>
        <button @click="resetButton">リセット</button>
        <button @click="addMinuteButton">分</button>
        <button @click="addSecondButton">秒</button>
        <button>1分</button>
        <button>2分</button>
        <button>3分</button>
        <button>4分</button>
        <button>6分</button>
        <button>秒数入力</button>
      </div>
    </div>
    <script type="text/javascript">
      const TkTimerStateValue = Object.freeze({
        INITIAL_STATE: 'INITIAL_STATE',
        SETTING_TIME: 'SETTING_TIME',
        COUNTING_DOWN: 'COUNTING_DOWN',
        PAUSING_COUNTING_DOWN: 'PAUSING_COUNTING_DOWN',
        COUNTING_DOWN_COMPLETED: 'COUNTING_DOWN_COMPLETED',
      })
      const TkTimerState = function () {
        this.state = TkTimerStateValue.INITIAL_STATE
      }
      TkTimerState.prototype.canGoToInitialState = function () {
        return true // どこからも許可
      }
      TkTimerState.prototype.goToInitialState = function () {
        if (!this.canGoToInitialState()) {
          return
        }
        this.state = TkTimerStateValue.INITIAL_STATE
      }
      TkTimerState.prototype.isInitialState = function () {
        return this.state === TkTimerStateValue.INITIAL_STATE
      }
      TkTimerState.prototype.canGoToSettingTime = function () {
        return this.isInitialState() || this.isSettingTime()
      }
      TkTimerState.prototype.goToSettingTime = function () {
        if (!this.canGoToSettingTime()) {
          return
        }
        this.state = TkTimerStateValue.SETTING_TIME
      }
      TkTimerState.prototype.isSettingTime = function () {
        return this.state === TkTimerStateValue.SETTING_TIME
      }
      TkTimerState.prototype.canGoToCountingDown = function () {
        return this.isSettingTime() || this.isPausingCountDown()
      }
      TkTimerState.prototype.goToCountingDown = function () {
        if (!this.canGoToCountingDown()) {
          return
        }
        this.state = TkTimerStateValue.COUNTING_DOWN
      }
      TkTimerState.prototype.isCountingDown = function () {
        return this.state === TkTimerStateValue.COUNTING_DOWN
      }
      TkTimerState.prototype.canGoToPausingCountDown = function () {
        return this.isCountingDown()
      }
      TkTimerState.prototype.goToPausingCountDown = function () {
        if (!this.canGoToPausingCountDown()) {
          return
        }
        this.state = TkTimerStateValue.PAUSING_COUNTING_DOWN
      }
      TkTimerState.prototype.isPausingCountDown = function () {
        return this.state === TkTimerStateValue.PAUSING_COUNTING_DOWN
      }
      TkTimerState.prototype.canGoToCountingDownCompleted = function () {
        return this.isCountingDown()
      }
      TkTimerState.prototype.goToCountingDownCompleted = function () {
        if (!this.canGoToCountingDownCompleted()) {
          return
        }
        this.state = TkTimerStateValue.COUNTING_DOWN_COMPLETED
      }
      TkTimerState.prototype.isCountingDownCompleted = function () {
        return this.state === TkTimerStateValue.COUNTING_DOWN_COMPLETED
      }

      // 数値表示コンポーネント定義
      // タイマーディスプレイ定義
      // タイマーUI定義
      // タイマーロジック定義
      const TkTimer = function (callback) {
        this.tickCallback = callback
        this.state = new TkTimerState()
        this.init()
      }
      TkTimer.prototype.clearTimer = function () {
        clearInterval(this.timerId)
        this.timerId = null
        this.tickStartedAtMsec = null
        this.lastTimeTickedSec = 0
      }
      TkTimer.prototype.init = function () {
        this.clearTimer()
        this.rememberedTargetSec = 0
        this.currentSec = 0
      }
      TkTimer.prototype.notifyCurrentSec = function () {
        if (this.tickCallback) {
          this.tickCallback(this.currentSec)
        }
      }
      TkTimer.prototype.setSec = function (sec) {
        if (!this.state.canGoToSettingTime()) {
          return
        }
        this.currentSec = sec
        this.notifyCurrentSec()
        this.state.goToSettingTime()
      }
      TkTimer.prototype.addMinute = function () {
        if (!this.state.canGoToSettingTime()) {
          return
        }
        this.currentSec += 60
        this.notifyCurrentSec()
        this.state.goToSettingTime()
      }
      TkTimer.prototype.addSecond = function () {
        if (!this.state.canGoToSettingTime()) {
          return
        }
        this.currentSec += 1
        this.notifyCurrentSec()
        this.state.goToSettingTime()
      }
      TkTimer.prototype.onSecTick = function () {
        if (this.state.isCountingDown()) {
          this.currentSec -= 1
          this.notifyCurrentSec()
          if (this.currentSec === 0) {
            this.state.goToCountingDownCompleted()
            this.clearTimer()
          }
        } else {
          // いつかupも実装
        }
      }
      TkTimer.prototype.onIntervalTick = function () {
        // スタート時点の時刻と現在時刻を比較して正確な経過時間を計測する
        const currentTime = Date.now()
        const d = currentTime - this.tickStartedAtMsec
        const timeTickedSec = Math.floor(d / 1000)
        if (timeTickedSec !== this.lastTimeTickedSec) {
          this.onSecTick()
          this.lastTimeTickedSec = timeTickedSec
        }
      }
      TkTimer.prototype.start = function () {
        if (this.state.canGoToCountingDown()) {
          if (this.currentSec === 0) {
            return
          }
          if (this.state.isSettingTime()) {
            // 新規にカウントダウンをスタートする場合だけ設定時間を覚えておく
            this.rememberedTargetSec = this.currentSec
          }
          this.state.goToCountingDown()
          this.tickStartedAtMsec = Date.now()
          const that = this
          this.timerId = setInterval(function () {
            that.onIntervalTick()
          }, 50)
        } else {
          // いつかupも実装
        }
      }
      TkTimer.prototype.pause = function () {
        if (!this.state.canGoToPausingCountDown()) {
          return
        }
        this.clearTimer()
        this.state.goToPausingCountDown()
      }
      TkTimer.prototype.restore = function () {
        if (this.state.canGoToSettingTime()) {
          this.currentSec = this.rememberedTargetSec
          this.state.goToSettingTime()
        }
      }
      TkTimer.prototype.reset = function () {
        if (this.state.canGoToInitialState()) {
          this.init()
          this.state.goToInitialState()
        }
      }

      const app = new Vue({
        el: '#timer-ui',
        data: function () {
          return { currentSec: 0, timer: new TkTimer(this.onTick) }
        },
        methods: {
          onTick: function (sec) {
            this.currentSec = sec
          },
          startButton: function () {
            this.timer.start()
          },
          stopButton: function () {
            this.timer.pause()
          },
          resetButton: function () {},
          addMinuteButton: function () {
            this.timer.addMinute()
          },
          addSecondButton: function () {
            this.timer.addSecond()
          },
        },
        mounted: function () {},
      })
    </script>
  </body>
</html>
