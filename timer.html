<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8" />
    <title>タイマー</title>
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue@2"></script> -->
  </head>
  <body>
    <div id="timer-ui">
      <div>{{currentSec}}</div>
      <div>
        <div>00:00</div>
        <button @click="startButton">スタート</button>
        <button @click="stopButton">ストップ</button>
        <button @click="resetButton">リセット</button>
        <button @click="addMinuteButton">分</button>
        <button @click="addSecondButton">秒</button>
        <button>1分</button>
        <button>2分</button>
        <button>3分</button>
        <button>4分</button>
        <button>6分</button>
        <button>秒数入力</button>
      </div>
    </div>
    <script type="text/javascript">
      var TkTimerState = function () {
        this.state = "initial";
      };
      TkTimerState.prototype.goToSetTime = function () {
        this.state = "setTime";
      };
      TkTimerState.prototype.canGoSetTime = function () {
        return true;
      };
      TkTimerState.prototype.goToCountingDown = function () {
        this.state = "counting_down";
      };
      TkTimerState.prototype.canGoToCountingDown = function () {
        return true;
      };
      TkTimerState.prototype.isCountingDown = function () {
        return this.state === "counting_down";
      };
      TkTimerState.prototype.goToPausingCountDown = function () {
        this.state = "pausing_count_down";
      };
      TkTimerState.prototype.canGoToPausingCountDown = function () {
        return true;
      };
      TkTimerState.prototype.goToCountDownCompleted = function () {
        this.state = "count_down_completed";
      };
      TkTimerState.prototype.canGoToCountDownCompleted = function () {
        return true;
      };

      // 数値表示コンポーネント定義
      // タイマーディスプレイ定義
      // タイマーUI定義
      // タイマーロジック定義
      var TkTimer = function (callback) {
        this.tickCallback = callback;
        this.state = new TkTimerState();
        this.reset();
      };
      TkTimer.prototype.clearTimer = function () {
        clearInterval(this.timerId);
        this.timerId = null;
        this.tickStartedAtMsec = null;
        this.lastTimeTickedSec = 0;
      };
      TkTimer.prototype.reset = function () {
        this.clearTimer();
        this.targetSec = 0;
        this.currentSec = 0;
      };
      TkTimer.prototype.notifyCurrentSec = function () {
        if (this.tickCallback) {
          this.tickCallback(this.currentSec);
        }
      };
      TkTimer.prototype.setSec = function (sec) {
        if (!this.state.canGoSetTime()) {
          return;
        }
        this.currentSec = sec;
        this.notifyCurrentSec();
      };
      TkTimer.prototype.addMinute = function () {
        if (!this.state.canGoSetTime()) {
          return;
        }
        this.currentSec += 60;
        this.notifyCurrentSec();
      };
      TkTimer.prototype.addSecond = function () {
        if (!this.state.canGoSetTime()) {
          return;
        }
        this.currentSec += 1;
        this.notifyCurrentSec();
      };
      TkTimer.prototype.onSecTick = function () {
        if (this.state.isCountingDown()) {
          this.currentSec -= 1;
          this.notifyCurrentSec();
          if (this.currentSec === 0) {
            this.state.goToCountDownCompleted();
            this.clearTimer();
          }
        } else {
          // いつかupも実装
        }
      };
      TkTimer.prototype.onIntervalTick = function () {
        // スタート時点の時刻と現在時刻を比較して正確な経過時間を計測する
        var currentTime = Date.now();
        var d = currentTime - this.tickStartedAtMsec;
        var timeTickedSec = Math.floor(d / 1000);
        if (timeTickedSec !== this.lastTimeTickedSec) {
          this.onSecTick();
          this.lastTimeTickedSec = timeTickedSec;
        }
      };
      TkTimer.prototype.start = function () {
        this.state.goToCountingDown();
        this.tickStartedAtMsec = Date.now();
        var that = this;
        this.timerId = setInterval(function () {
          that.onIntervalTick();
        }, 50);
      };
      TkTimer.prototype.pause = function () {
        this.clearTimer();
      };
      TkTimer.prototype.restore = function () {};

      var app = new Vue({
        el: "#timer-ui",
        data: function () {
          return { currentSec: 0, timer: new TkTimer(this.onTick) };
        },
        methods: {
          onTick: function (sec) {
            this.currentSec = sec;
          },
          startButton: function () {
            this.timer.start();
          },
          stopButton: function () {
            this.timer.pause();
          },
          resetButton: function () {},
          addMinuteButton: function () {
            this.timer.addMinute();
          },
          addSecondButton: function () {
            this.timer.addSecond();
          },
        },
        mounted: function () {},
      });
    </script>
  </body>
</html>
