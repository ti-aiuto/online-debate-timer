<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>タイマー</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/vue@2"></script> -->
    <style type="text/css">
      * {
        margin: 0;
        padding: 0;
      }

      .timer-time {
        font-size: 6rem;
        line-height: 6rem;
        text-align: center;
        margin: 12px 0;
        font-family: monospace;
      }

      .timer-control-button {
        font-size: 1.3rem;
        margin: 4px;
        padding: 8px;
        border-radius: 12px;
        font-family: monospace;
      }

      .copyright, .copyright a {
        font-size: 0.7rem;
        color: #aaa;
      }
    </style>
  </head>
  <body>
    <div id="timer-ui">
      <time-display :sec="currentSec"></time-display>
      <div>
        <button @click="startButton" class="timer-control-button">
          スタート
        </button>
        <button @click="stopButton" class="timer-control-button">
          ストップ
        </button>
      </div>
      <div>
        <button @click="restoreButton" class="timer-control-button">
          鳴動停止
        </button>
        <button @click="resetButton" class="timer-control-button">
          リセット
        </button>
        <button @click="inputSecAndSetButton" class="timer-control-button">
          秒数入力
        </button>
      </div>
      <div>
        <button @click="addMinuteButton" class="timer-control-button">
          +分
        </button>
        <button @click="addSecondButton" class="timer-control-button">
          +秒
        </button>
      </div>
      <div>
        <button @click="setSecButton(60)" class="timer-control-button">
          1分
        </button>
        <button @click="setSecButton(120)" class="timer-control-button">
          2分
        </button>
        <button @click="setSecButton(180)" class="timer-control-button">
          3分
        </button>
        <button @click="setSecButton(240)" class="timer-control-button">
          4分
        </button>
        <button @click="setSecButton(360)" class="timer-control-button">
          6分
        </button>
      </div>
    </div>
    <div class="copyright">
      by ti-aiuto<br>
      <a href="https://github.com/ti-aiuto/online-debate-timer"
        >https://github.com/ti-aiuto/online-debate-timer</a
      >
    </div>
    <script type="text/javascript">
      // タイマーの状態遷移を整理したオブジェクト
      const TkTimerStateValue = Object.freeze({
        INITIAL_STATE: 'INITIAL_STATE',
        SETTING_TIME: 'SETTING_TIME',
        COUNTING_DOWN: 'COUNTING_DOWN',
        PAUSING_COUNTING_DOWN: 'PAUSING_COUNTING_DOWN',
        COUNTING_DOWN_COMPLETED: 'COUNTING_DOWN_COMPLETED',
      })
      const TkTimerState = function () {
        this.state = TkTimerStateValue.INITIAL_STATE
      }
      TkTimerState.prototype.canGoToInitialState = function () {
        return true // どこからも許可
      }
      TkTimerState.prototype.goToInitialState = function () {
        if (!this.canGoToInitialState()) {
          return
        }
        this.state = TkTimerStateValue.INITIAL_STATE
      }
      TkTimerState.prototype.isInitialState = function () {
        return this.state === TkTimerStateValue.INITIAL_STATE
      }
      TkTimerState.prototype.canGoToSettingTime = function () {
        return (
          this.isInitialState() ||
          this.isSettingTime() ||
          this.isCountingDownCompleted()
        )
      }
      TkTimerState.prototype.goToSettingTime = function () {
        if (!this.canGoToSettingTime()) {
          return
        }
        this.state = TkTimerStateValue.SETTING_TIME
      }
      TkTimerState.prototype.isSettingTime = function () {
        return this.state === TkTimerStateValue.SETTING_TIME
      }
      TkTimerState.prototype.canGoToCountingDown = function () {
        return this.isSettingTime() || this.isPausingCountDown()
      }
      TkTimerState.prototype.goToCountingDown = function () {
        if (!this.canGoToCountingDown()) {
          return
        }
        this.state = TkTimerStateValue.COUNTING_DOWN
      }
      TkTimerState.prototype.isCountingDown = function () {
        return this.state === TkTimerStateValue.COUNTING_DOWN
      }
      TkTimerState.prototype.canGoToPausingCountDown = function () {
        return this.isCountingDown()
      }
      TkTimerState.prototype.goToPausingCountDown = function () {
        if (!this.canGoToPausingCountDown()) {
          return
        }
        this.state = TkTimerStateValue.PAUSING_COUNTING_DOWN
      }
      TkTimerState.prototype.isPausingCountDown = function () {
        return this.state === TkTimerStateValue.PAUSING_COUNTING_DOWN
      }
      TkTimerState.prototype.canGoToCountingDownCompleted = function () {
        return this.isCountingDown()
      }
      TkTimerState.prototype.goToCountingDownCompleted = function () {
        if (!this.canGoToCountingDownCompleted()) {
          return
        }
        this.state = TkTimerStateValue.COUNTING_DOWN_COMPLETED
      }
      TkTimerState.prototype.isCountingDownCompleted = function () {
        return this.state === TkTimerStateValue.COUNTING_DOWN_COMPLETED
      }

      // タイマーロジック
      const TkTimer = function (callback) {
        this.tickCallback = callback
        this.state = new TkTimerState()
        this.init()
      }
      TkTimer.prototype.clearTimer = function () {
        clearInterval(this.timerId)
        this.timerId = null
        this.tickStartedAtMsec = null
        this.lastTimeTickedSec = 0
      }
      TkTimer.prototype.init = function () {
        this.clearTimer()
        this.rememberedTargetSec = 0
        this.currentSec = 0
      }
      TkTimer.prototype.notifyCurrentSec = function () {
        if (this.tickCallback) {
          this.tickCallback(this.currentSec)
        }
      }
      TkTimer.prototype.setSec = function (sec) {
        if (!this.state.canGoToSettingTime()) {
          return
        }
        this.currentSec = sec
        this.notifyCurrentSec()
        this.state.goToSettingTime()
      }
      TkTimer.prototype.addMinute = function () {
        if (!this.state.canGoToSettingTime()) {
          return
        }
        this.currentSec += 60
        this.notifyCurrentSec()
        this.state.goToSettingTime()
      }
      TkTimer.prototype.addSecond = function () {
        if (!this.state.canGoToSettingTime()) {
          return
        }
        this.currentSec += 1
        this.notifyCurrentSec()
        this.state.goToSettingTime()
      }
      TkTimer.prototype.onSecTick = function () {
        if (this.state.isCountingDown()) {
          this.currentSec -= 1
          this.notifyCurrentSec()
          if (this.currentSec === 0) {
            this.state.goToCountingDownCompleted()
            this.clearTimer()
          }
        } else {
          // いつかupも実装
        }
      }
      TkTimer.prototype.onIntervalTick = function () {
        // スタート時点の時刻と現在時刻を比較して正確な経過時間を計測する
        const currentTime = Date.now()
        const d = currentTime - this.tickStartedAtMsec
        const timeTickedSec = Math.floor(d / 1000)
        if (timeTickedSec !== this.lastTimeTickedSec) {
          this.onSecTick()
          this.lastTimeTickedSec = timeTickedSec
        }
      }
      TkTimer.prototype.start = function () {
        if (this.state.canGoToCountingDown()) {
          if (this.currentSec === 0) {
            return
          }
          if (this.state.isSettingTime()) {
            // 新規にカウントダウンをスタートする場合だけ設定時間を覚えておく
            this.rememberedTargetSec = this.currentSec
          }
          this.state.goToCountingDown()
          this.tickStartedAtMsec = Date.now()
          const that = this
          this.timerId = setInterval(function () {
            that.onIntervalTick()
          }, 50)
        } else {
          // いつかupも実装
        }
      }
      TkTimer.prototype.pause = function () {
        if (!this.state.canGoToPausingCountDown()) {
          return
        }
        this.clearTimer()
        this.state.goToPausingCountDown()
      }
      TkTimer.prototype.restore = function () {
        if (this.state.canGoToSettingTime()) {
          this.setSec(this.rememberedTargetSec)
          // 遷移は中でやってくれる
        }
      }
      TkTimer.prototype.reset = function () {
        if (this.state.canGoToInitialState()) {
          this.init()
          this.notifyCurrentSec()
          this.state.goToInitialState()
        }
      }

      const zeroPadding = function (number) {
        return ('000' + number).slice(-2)
      }

      const toHankakuNumber = function (str) {
        return str.replace(/[０-９]/g, function (s) {
          return String.fromCharCode(s.charCodeAt(0) - 0xfee0)
        })
      }

      // タイマーの数値表示部分のコンポーネント
      Vue.component('time-display', {
        template: '<div class="timer-time">{{minutes}}:{{seconds}}</div>',
        props: {
          sec: {
            type: Number,
            required: true,
          },
        },
        computed: {
          minutes: function () {
            return zeroPadding(Math.floor(this.sec / 60))
          },
          seconds: function () {
            return zeroPadding(this.sec % 60)
          },
        },
      })

      // タイマーUI
      const app = new Vue({
        el: '#timer-ui',
        data: function () {
          return { currentSec: 0, timer: new TkTimer(this.onTick) }
        },
        methods: {
          onTick: function (sec) {
            this.currentSec = sec
          },
          startButton: function () {
            this.timer.start()
          },
          stopButton: function () {
            this.timer.pause()
          },
          restoreButton: function () {
            this.timer.restore()
          },
          resetButton: function () {
            this.timer.reset()
          },
          addMinuteButton: function () {
            this.timer.addMinute()
          },
          addSecondButton: function () {
            this.timer.addSecond()
          },
          setSecButton: function (sec) {
            this.timer.setSec(sec)
          },
          inputSecAndSetButton: function () {
            const result = window.prompt('秒数を入力')
            if (!result || result === '') {
              return
            }
            this.setSecButton(Number(toHankakuNumber(result)))
          },
        },
        mounted: function () {},
      })
    </script>
  </body>
</html>
